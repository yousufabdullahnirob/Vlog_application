import requests
import random

BASE_URL = "http://127.0.0.1:8000/api"
AUTH_URL = "http://127.0.0.1:8000/api/user/register/"
TOKEN_URL = "http://127.0.0.1:8000/api/token/"

def register_user(username, password):
    # Try to register, if fails assume exists
    requests.post(AUTH_URL, json={"username": username, "password": password, "email": f"{username}@example.com"})

def get_token(username, password):
    r = requests.post(TOKEN_URL, json={"username": username, "password": password})
    if r.status_code == 200:
        return r.json()["access"]
    print(f"Failed to get token for {username}: {r.text}")
    return None

def run_test():
    # 1. Setup two users
    print("Setting up users...")
    register_user("attacker", "password123")
    register_user("victim", "password123")
    
    attacker_token = get_token("attacker", "password123")
    victim_token = get_token("victim", "password123")
    
    if not attacker_token or not victim_token:
        print("Failed to authenticate test users.")
        return

    # 2. Victim creates a post
    print("Victim creating post...")
    headers_victim = {"Authorization": f"Bearer {victim_token}"}
    slug = f"victim-post-{random.randint(1000,9999)}"
    post_data = {"title": "Victim Post", "slug": slug, "content": "My content", "is_published": True}
    r = requests.post(f"{BASE_URL}/posts/", json=post_data, headers=headers_victim)
    if r.status_code != 201:
        print(f"Victim failed to create post: {r.text}")
        return
    post_id = r.json()["id"]
    print(f"Victim post created. ID: {post_id}")

    # 3. Attacker deletes the post
    print("Attacker attempting to delete victim's post...")
    headers_attacker = {"Authorization": f"Bearer {attacker_token}"}
    r_delete = requests.delete(f"{BASE_URL}/posts/{post_id}/", headers=headers_attacker)
    
    if r_delete.status_code == 204:
        print("!!! SECURITY VULNERABILITY CONFIRMED !!!")
        print("Attacker successfully deleted victim's post.")
    elif r_delete.status_code == 403:
        print("Security Check Passed: Attacker was forbidden (403).")
    else:
        print(f"Unexpected status: {r_delete.status_code} - {r_delete.text}")

if __name__ == "__main__":
    run_test()
